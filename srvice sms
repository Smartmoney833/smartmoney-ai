const axios = require('axios');

async function sendViaMSG91(phone, text) {
  const authKey = process.env.MSG91_AUTH_KEY;
  const sender = process.env.MSG91_SENDER || 'SMARTM';
  if (!authKey) {
    console.log('[SMS DEMO] not configured. Would send to', phone, 'text:', text);
    return;
  }

  try {
    const url = 'https://control.msg91.com/api/sendhttp.php';
    const params = new URLSearchParams();
    params.append('authkey', authKey);
    params.append('mobiles', phone);
    params.append('message', text);
    params.append('sender', sender);
    params.append('route', '4');

    const resp = await axios.post(url, params.toString(), {
      headers: { 'Content-Type': 'application/x-www-form-urlencoded' }
    });
    console.log('[MSG91] response:', resp.data);
  } catch (err) {
    console.error('MSG91 error:', err.message || err);
  }
}

module.exports = {
  sendOTP: async ({ phone, email, code }) => {
    const text = `Your SmartMoney AI OTP is ${code}. Valid for 2 minutes. Do not share.`;
    if (phone) await sendViaMSG91(phone, text);
    if (email) console.log('[Email DEMO] to', email, 'text:', text);
  }
};
